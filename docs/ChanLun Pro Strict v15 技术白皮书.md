# ChanLun Pro Strict v15 技术白皮书

**版本**: v15 (Strict Dynamics & Seamless Segments) **发布日期**: 2023-10-27 **核心架构**: 递归几何结构 + 动力学约束 + 统计学过滤 + 机构级风控

## 1. 概述 (Executive Summary)

**ChanLun Pro Strict v15** 是缠论量化系统的一个里程碑版本。本版本彻底重构了底层的几何构建逻辑，旨在解决传统缠论策略中“中枢定义模糊”、“线段断裂”以及“假突破信号多”的三大痛点。

通过引入 **严格中枢动力学 (Strict Center Dynamics)** 和 **线段极值追踪 (Segment Peak Tracking)** 算法，v15 能够精准识别趋势的中继与转折，并配合 **1% 固定风险模型**，实现“截断亏损，让利润奔跑”的交易目标。

## 2. 核心算法改进 (Core Algorithms)

### 2.1 线段无缝连接技术 (Seamless Segment Technology)

在旧版本及市面大多数缠论指标中，线段往往连接的是“成笔的终点”，导致在快速行情的极值点出现“断笔”或“悬空”现象。v15 引入了状态机修复：

- **极值锁定 (Peak Tracking)**: 在线段生长过程中，系统实时扫描并锁定当前走势的绝对最高/最低点（Peak Stroke）。
- **强制锚定 (Forced Anchoring)**:
  - **起点修正**: 新线段的起点坐标 $(x_0, y_0)$ 被强制设定为上一线段的终点坐标，消除任何像素级的视觉缝隙。
  - **终点回溯**: 当线段被反向笔破坏确认时，系统回溯至记录的 `Peak` 处画线，确保线段完美覆盖走势的真实极值。
- **最小笔数硬闸**: 严格执行 `MinStrokesPerSeg` (默认3笔) 约束，不足3笔的破坏仅被视为段内回撤，不生成新线段，有效过滤噪音。

### 2.2 严格中枢动力学 (Strict Center Dynamics)

这是 v15 的核心护城河。我们不再仅仅根据“价格重叠”来绘制中枢，而是加入了**向量方向**的约束：

- **形态序列约束 (Pattern Sequence)**:
  - 中枢内部的三笔必须满足严格的反向交替。
  - **上升中枢构建**: 必须是 `下 -> 上 -> 下` 序列。
  - **下降中枢构建**: 必须是 `上 -> 下 -> 上` 序列。
- **进出同向验证 (Vector Consistency)**:
  - 系统记录 **进入笔 (Enter Stroke)** 和 **离开笔 (Exit Stroke)** 的方向向量。
  - 只有当 `Vector_Enter == Vector_Exit` 时，该重叠区才被认定为具有趋势延续性的有效中枢。
  - *意义*: 这彻底排除了震荡扩大的喇叭口形态被误判为趋势中枢的情况，极大地提纯了 C3 (三买/三卖) 的信号质量。

## 3. 信号系统 (Signal Logic)

### 3.1 C1: 趋势背驰 (Trend Reversal)

- **定义**: 趋势的尽头，左侧交易点。
- **逻辑**:
  1. **结构背驰**: 当前价格创出新低/新高，但动能指标 (MACD) 减弱。
  2. **线段端对端比对**: (v15升级) 比对的是“上一线段终点”与“当前线段峰值”的力度，而非仅仅比对两笔，跨度更大，信号更稳。
  3. **高斯过滤 (Gaussian Filter)**: 价格必须触及高斯通道下轨(买)或上轨(卖)，确保处于统计学的极端区域。

### 3.2 C2: 次级别确认 (Second Confirmation)

- **定义**: 趋势反转后的第一次回踩确认，右侧交易点。
- **逻辑**:
  1. 前序必须有 C1 信号（或潜在背驰）。
  2. **不破结构**: 回调笔的最低点 > 前一笔(C1)的最低点 (底分型抬高)。

### 3.3 C3: 趋势爆发 (Trend Explosion)

- **定义**: 中枢破坏后的回踩确认，主升浪起点。

- **逻辑**:

  1. **严格依赖中枢属性**: 买点只发生在“上升中枢”上方；卖点只发生在“下降中枢”下方。
  2. **不回中枢**: 离开中枢后，回踩笔的**极值** (Low for Buy / High for Sell) 绝对不触及中枢边界 (ZG/ZD)。

  - *v15 改进*: 使用笔的极值而非收盘价进行判定，防止影线刺破中枢造成的假信号。

## 4. 资金管理系统 (Risk Management)

v15 内置了机构级的资金管理模块，这是策略长期盈利的关键。

### 4.1 1% 固定风险模型 (Fixed Fractional Position Sizing)

系统不再固定手数，而是根据止损距离动态计算仓位：

$$\text{Position Size} = \frac{\text{Account Equity} \times 1\%}{|\text{Entry Price} - \text{Stop Loss}|}$$

- **窄止损 (C2/C3)**: 自动加大仓位，博取高盈亏比。
- **宽止损 (C1)**: 自动减小仓位，控制单笔最大亏损。

### 4.2 三段式止盈策略 (3-Stage Scaling Out)

将每一个仓位在逻辑上分为三份独立管理：

| 阶段        | 触发条件        | 动作       | 剩余仓位止损 (SL)    | 战术目的                   |
| ----------- | --------------- | ---------- | -------------------- | -------------------------- |
| **Stage 1** | 浮盈达到 **1R** | 平仓 1/3   | 移至 **开仓价 (BE)** | **零风险博弈 (Free Ride)** |
| **Stage 2** | 浮盈达到 **2R** | 平仓 1/3   | 移至 **1R 利润处**   | **锁定胜局 (Bank Profit)** |
| **Stage 3** | 趋势延续        | 不设硬止盈 | 跟随结构/反向信号    | **博取暴利 (Trend Run)**   |

## 5. 工程优化 (Engineering)

### 5.1 模块化架构 (Modular Architecture) [NEW]

为了适应 Pine Script v6 的特性并提高代码的可维护性，v15 采用了模块化设计：

- **src/main.pine**: 主入口，负责参数配置、数据预处理和信号调度。
- **src/libraries/ChanLunLib.pine**: 核心算法库，封装了 `Stroke` (笔)、`Center` (中枢) 和 `Segment` (线段) 的 UDT (用户自定义类型) 和状态机逻辑。
- **src/libraries/DrawingLib.pine**: 绘图与资源管理库，实现了基于对象池的垃圾回收机制 (Garbage Collection)。

### 5.2 垃圾回收机制 (Garbage Collection)

针对 TradingView `Max Drawing Limit` (通常为 500) 的限制，v15 实现了自动 GC：

- **对象池**: 维护 `gc_lines`, `gc_boxes`, `gc_labels` 队列。
- **自动清理**: 当对象数量超过 **400** 时，自动销毁最早生成的对象。
- **效果**: 允许在极长的时间周期（如 10000 根 K 线）上进行回测而不报错，且始终保留最新的结构图表。

### 5.3 信号熔断与去抖 (Debouncing)

- **单K线单信号**: 引入 `stroke_node_changed` 锁，确保在同一根 K 线收盘时，只触发优先级最高的一个信号 (C3 > C2 > C1)。
- **反手逻辑**: 当反向信号触发时 (如持多单时出现一卖)，优先平掉旧仓位的尾仓 (`Run`), 再开设新仓位。

## 6. 参数配置建议

| 参数组        | 参数名                | 推荐值         | 说明                       |
| ------------- | --------------------- | -------------- | -------------------------- |
| **Structure** | `minBarsStroke`       | **4**          | 严格老笔定义，过滤杂波     |
| **Structure** | `minStrokesPerSeg`    | **3**          | 标准线段定义               |
| **Filters**   | `use_gaussian_filter` | **True**       | 建议开启，大幅提高 C1 胜率 |
| **Risk**      | `risk_per_trade`      | **1.0**        | 稳健型 1%，激进型 2%       |
| **Risk**      | `exit_R_Levels`       | **"1.0, 2.0"** | 经典斐波那契或整数倍率     |

**结语**: ChanLun Pro Strict v15 不是一个简单的指标，而是一套完整的交易系统。它通过严谨的数学定义解决了“千人千缠”的主观性问题，并通过科学的资金管理解决了“看对做错”的执行问题。